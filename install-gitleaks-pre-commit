#!/bin/sh
# Colors
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

# Create hook in given directory
create_hook() {
    mkdir -p "$1/hooks"  # Create hooks directory if it doesn't exist
    cat > "$1/hooks/pre-commit" << 'HOOK'
#!/bin/sh
if ! command -v gitleaks >/dev/null 2>&1; then
    echo "Gitleaks is not installed. Please install it to proceed."
    if [ "$(uname)" = "Darwin" ]; then
        echo "  brew install gitleaks"
    else
        echo "  https://github.com/gitleaks/gitleaks#installing"
    fi
    exit 1
fi
gitleaks git --staged -v
if [ $? -ne 0 ]; then
    echo "Gitleaks detected sensitive information. Please fix before committing."
    exit 1
fi
echo "***** Gitleaks check completed successfully *****"
HOOK
    chmod +x "$1/hooks/pre-commit"
}

# Find and update repositories
find_and_update_repos() {
    [ ! -d "$1" ] && echo "${YELLOW}Directory not found: $1${NC}" && return 1
    echo "${YELLOW}Searching in: $1${NC}"
    find "$1" -type d -name ".git" 2>/dev/null | while read gitdir; do
        create_hook "$gitdir"
        echo "${GREEN}✔ Installed in: $(dirname "$gitdir")${NC}"
    done
}

case "$1" in
    "all")
        find_and_update_repos "$HOME/projects"
        find_and_update_repos "$HOME/workspace"
        find_and_update_repos "$HOME/repos"
        find_and_update_repos "$HOME/Documents"
        ;;
    *)
        [ -z "$1" ] && echo "Usage: curl ... | sh -s all  # or  curl ... | sh -s ~/path" && exit 1
        find_and_update_repos "$1"
        ;;
esac
echo "${GREEN}✔ Update complete!${NC}"
